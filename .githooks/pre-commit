#!/usr/bin/env bash
# =================================================================
# Pre-commit Hook for FoundationRelativity (Post-Phase 2B)
# Phases 2A, 2B, 3 complete - Now working on Phases 4-6
# Updated: October 18, 2025
# =================================================================
set -euo pipefail

#-----------------------------------------------------------------
# GUARD 1: Keep sumIdx_expand local-only (never global [simp])
#-----------------------------------------------------------------
# Ignore commented additions (+ -- or + /-) and only flag *global* 'attribute [simp]' (not 'local attribute')
if git diff --cached -U0 \
  | grep -E '^\+' \
  | grep -vE '^\+\s*--|^\+\s*/-' \
  | grep -E '^\+\s*attribute\s*\[simp\].*sumIdx_expand' >/dev/null; then
  echo "❌ Refusing commit: make 'sumIdx_expand' [simp] local inside the split section, not global." >&2
  exit 1
fi

#-----------------------------------------------------------------
# GUARD 2: Build Verification (CRITICAL)
#-----------------------------------------------------------------
# Only run for GR changes to keep commits snappy
if git diff --cached --name-only | grep -qE '^Papers/P5_GeneralRelativity/GR/'; then
  echo "▶ Building Riemann.lean (incremental)..."

  # Run baseline check (0 errors required)
  ./scripts/check-baseline.sh || exit 1

  # Show sorry/axiom progress
  echo "▶ Analyzing progress..."
  ./scripts/check-progress.sh
fi

#-----------------------------------------------------------------
# GUARD 3: Documentation Integrity
#-----------------------------------------------------------------
if git diff --cached --name-only | grep -qE '\.md$'; then
  # Check for dependencies (Python scripts need certain packages)
  ./scripts/check-deps.sh >/dev/null 2>&1 || {
    echo "❌ Missing dependencies. Run ./scripts/check-deps.sh for details." >&2
    exit 1
  }

  echo "▶ Auditing documentation links..."
  ./scripts/audit-doc-links.sh || {
    echo "❌ Docs link audit failed. Fix broken links or update references." >&2
    exit 1
  }

  echo "▶ Auditing documentation anchors..."
  ./scripts/audit-doc-anchors.sh || {
    echo "❌ Docs anchor audit failed. Fix headings or fragments." >&2
    exit 1
  }
fi

#-----------------------------------------------------------------
# SUCCESS
#-----------------------------------------------------------------
echo "✅ All checks passed!"
