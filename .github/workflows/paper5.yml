name: Paper 5 ‚Äì build, audit, and PDF

on:
  push:
    branches: [ main, 'paper5/**', 'feature/**' ]
    tags:
      - 'paper5-v*'
  pull_request:
    branches: [ main ]
    paths:
      - 'Papers/P5_GeneralRelativity/**'
      - 'scripts/**'
      - '.github/**'
      - 'README.md'
      - 'Makefile'

# Note: LEAN_ABORT_ON_SORRY removed to allow documented sorries
# See SORRY_ALLOWLIST.txt for authorized sorries
# Sorry checking is done via no_sorry.sh script below

jobs:
  lean:
    name: Build Lean + No-sorry + Axiom audit
    runs-on: ubuntu-latest
    if: ${{ !github.event.pull_request.draft }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Lean
        uses: leanprover/lean-action@v1
        with:
          use-mathlib-cache: true
          build-args: "-K 400000"

      - name: Cache .lake
        uses: actions/cache@v3
        with:
          path: |
            ~/.lake
            .lake/build
          key: ${{ runner.os }}-lake-p5-${{ hashFiles('lakefile.lean') }}

      - name: Build Smoke
        run: |
          echo "Building Paper 5 Smoke test..."
          lake build Papers.P5_GeneralRelativity.Smoke
          echo "‚úÖ Smoke test build completed"

      - name: Install dependencies
        run: |
          echo "Installing required tools..."
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Check dependencies
        run: |
          echo "Checking for required tools..."
          ./scripts/check-deps.sh

      - name: Riemann Quality Gates (informational)
        run: |
          echo "Running Riemann tensor activation quality gates..."
          # Non-blocking for now - remove '|| true' when ready to enforce
          make -C . check || true
          echo "See Papers/P5_GeneralRelativity/GR/README.md for activation documentation"

      - name: Documentation and signature audits (informational)
        run: |
          echo "Running comprehensive audit suite..."
          make -C . audit || true
          echo "Audit includes: Riemann checks, doc links, anchors, hub, and signatures"

      - name: No unauthorized sorries (Paper 5)
        run: |
          echo "Checking for unauthorized sorries in Paper 5..."
          # Find sorries in P5 files
          P5_SORRIES=$(find Papers/P5_GeneralRelativity -name "*.lean" -exec grep -Hn "sorry" {} \; | grep -v "^[[:space:]]*--" | awk -F: '{print $1":"$2}' | sort)
          VIOLATIONS=0
          for sorry in $P5_SORRIES; do
            if ! grep -q "^$sorry" SORRY_ALLOWLIST.txt; then
              echo "‚ùå UNAUTHORIZED: $sorry"
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
          done
          if [ $VIOLATIONS -gt 0 ]; then
            echo "üí• Found $VIOLATIONS unauthorized sorry statements in Paper 5"
            exit 1
          fi
          echo "‚úÖ All Paper 5 sorries are authorized"

      - name: Axiom audit
        run: |
          echo "Running axiom audit..."
          lake env lean scripts/AxiomAudit.lean | tee axiom-audit.txt

      - name: Run SchematicAudit
        run: bash scripts/SchematicAudit.sh

      - name: Run AxiomDeclAudit
        run: bash scripts/AxiomDeclAudit.sh

      - name: Run AxiomAudit (informational)
        run: lake env lean scripts/AxiomAudit.lean || true

      - uses: actions/upload-artifact@v4
        with:
          name: axiom-audit
          path: axiom-audit.txt

  pdf:
    name: Build Paper 5 PDF
    needs: lean
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Lightweight LaTeX build; your preamble has fallbacks so this is enough
      - name: Install TeXLive (minimal)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            texlive-latex-base texlive-latex-extra texlive-fonts-recommended \
            texlive-fonts-extra texlive-latex-recommended latexmk

      - name: Build Paper PDF
        working-directory: Papers/P5_GeneralRelativity
        run: |
          # Build PDF (allowing warnings but not errors)
          pdflatex -interaction=nonstopmode Paper5_GR_AxCal.tex || true
          pdflatex -interaction=nonstopmode Paper5_GR_AxCal.tex || true
          # Check that PDF was created
          if [ -f Paper5_GR_AxCal.pdf ]; then
            echo "‚úÖ PDF created successfully"
            ls -l Paper5_GR_AxCal.pdf
          else
            echo "‚ùå PDF creation failed"
            exit 1
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: paper5-pdf
          path: Papers/P5_GeneralRelativity/Paper5_GR_AxCal.pdf

  release:
    name: Attach PDF on tag
    needs: pdf
    if: startsWith(github.ref, 'refs/tags/paper5-v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: paper5-pdf
          path: dist
      - uses: softprops/action-gh-release@v2
        with:
          files: dist/Paper5_GR_AxCal.pdf