name: Nightly CI

on:
  schedule:
    # Run at 2 AM UTC every day
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger
  push:
    branches: [feat/godel-gap]  # Also run on Gödel-Gap development

env:
  LEAN_ABORT_ON_SORRY: 1

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/leanprover/lean4:v4.22.0-rc4  # Use stable RC4
    steps:
      - uses: actions/checkout@v3

      - name: Cache .lake
        uses: actions/cache@v3
        with:
          path: .lake
          key: ${{ runner.os }}-nightly-lake-${{ hashFiles('lake-manifest.json', 'lean-toolchain', 'lakefile.lean') }}
          restore-keys: |
            ${{ runner.os }}-nightly-lake-

      - name: Update Lean toolchain to nightly
        run: |
          echo "leanprover/lean4:nightly" > lean-toolchain
          lake update

      - name: Build
        run: lake build

      - name: Verify no 'sorry'
        run: |
          if [ -f scripts/verify-no-sorry.sh ]; then
            bash scripts/verify-no-sorry.sh
          else
            echo "Warning: verify-no-sorry.sh not found"
          fi

      - name: Run all tests
        run: |
          # Run all test executables if they exist
          for test in testFunctors testNonIdMorphisms WitnessTests AllPathologiesTests Gap2ProofTests APProofTests RNPProofTests RNP3ProofTests SpectralGapProofTests GodelGapProofTests; do
            if lake exe $test 2>/dev/null; then
              echo "✓ $test passed"
            else
              echo "⚠ $test not found or failed to build"
            fi
          done

  mathlib-bump:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/leanprover/lean4:v4.22.0-rc4
    steps:
      - uses: actions/checkout@v3

      - name: Update dependencies
        run: |
          echo "leanprover/lean4:nightly" > lean-toolchain
          lake update
          # Try to update mathlib to latest
          cd .lake/packages/mathlib && git pull origin main || true
          cd ../../..
          lake build mathlib

      - name: Create bump PR if successful
        if: success()
        uses: peter-evans/create-pull-request@v5
        with:
          title: 'chore: bump mathlib and Lean nightly'
          commit-message: 'chore: bump mathlib and Lean nightly'
          branch: auto/mathlib-bump
          delete-branch: true
          body: |
            Automated dependency bump from nightly CI.
            
            - Updates Lean to latest nightly
            - Updates mathlib to latest main
            
            Please review and merge if all tests pass.