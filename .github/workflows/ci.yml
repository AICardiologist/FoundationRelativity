name: CI

on: [push, pull_request]

env:
  LEAN_ABORT_ON_SORRY: 1

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Lean 4.3.0
        uses: leanprover/lean-action@v1
        with:
          use-mathlib-cache: true
          auto-config: true

      - name: Cache .lake
        uses: actions/cache@v3
        with:
          path: |
            ~/.lake
            .lake/build
          key: ${{ runner.os }}-lake-${{ hashFiles('lakefile.lean') }}

      - name: Build
        run: lake build

      - name: Verify no 'sorry'
        run: |
          if [ -f scripts/verify-no-sorry.sh ]; then
            bash scripts/verify-no-sorry.sh
          else
            echo "Warning: verify-no-sorry.sh not found"
          fi

      - name: Check no axioms
        run: scripts/check-no-axioms.sh

      - name: Run tests
        run: |
          # Run core tests that should always exist after PR merges
          for test in testFunctors testNonIdMorphisms WitnessTests AllPathologiesTests; do
            if lake exe $test 2>/dev/null; then
              echo "✓ $test passed"
            else
              echo "⚠ $test not found"
            fi
          done
          
          # Run proof tests if they exist
          for test in Gap2ProofTests APProofTests RNPProofTests RNP3ProofTests SpectralGapProofTests; do
            if lake exe $test 2>/dev/null; then
              echo "✓ $test passed"
            else
              echo "⚠ $test not found"
            fi
          done